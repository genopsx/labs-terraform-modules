name: Check Terraform Module Versions

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily

  pull_request:
    paths:
      - '**'
  push:
    paths:
      - '**'
    branches:
      - main


permissions: 
  id-token: write
  contents: read

env:
  DEBUG: true
  DEPLOY_ACCOUNT: ${{ vars.DEPLOY_ACCOUNT }}
  PROVISIONER_REGION: ${{ vars.PROVISIONER_REGION }}
  DEPLOYMENT_ROLE_NAME: ${{ vars.DEPLOYMENT_ROLE_NAME }}
  S3_BUCKET_NAME: tf-module-s3-ui
  SOURCE_TEFFORM_MODULES_PATH: ./templates
  SOURCE_TERRAFORM_MODULES_S3_UI: ./tf_module_checker_s3_ui
  DEPLOYMENT_ROLE_SESSION_NAME: github-action-tf-module-version-checker-session

jobs:
  check-modules:
    runs-on: ubuntu-latest
    environment: dev

    env:
        ACTIONS_RUNNER_DEBUG: true
        ACTIONS_STEP_DEBUG: true
        TERRAFORM_VERSION: 1.10.5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
         fetch-depth: 0
    
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
         node-version: '20'
    
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
         terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials With OIDC Assume Role
        id: configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
           role-to-assume: arn:aws:iam::${{ env.DEPLOY_ACCOUNT }}:role/${{ env.DEPLOYMENT_ROLE_NAME }}
           aws-region: ${{ env.PROVISIONER_REGION }}
           role-session-name: ${{ env.DEPLOYMENT_ROLE_SESSION_NAME }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}} 

      - name: Terraform Format Check
        run: terraform fmt -recursive -check
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}}

      - name: Install TFLint
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            curl -sSfL https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash -s -- -b $HOME/bin v0.53.0
            echo "$HOME/bin" >> $GITHUB_PATH
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}}

      - name: Terraform Lint
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            tflint --init
            tflint
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}}

      - name: Terraform Plan
        if: github.event_name == 'pull_request'
        run: terraform plan -no-color
        continue-on-error: true
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        if: github.event_name == 'push'
        working-directory: ${{ ENV.SOURCE_TERRAFORM_MODULES_S3_UI}} 

      - name: Get Repository URL
        id: repo_info
        run: echo "REPO_URL=https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Find Terraform Modules
        id: find_modules
        run: |
          echo "Searching for Terraform modules..."
          mkdir -p results
      
          # Find all .tf files in the repository
          find $GITHUB_WORKSPACE/$SOURCE_TEFFORM_MODULES_PATH -type f -name "*.tf" | while read -r file; do
            # Extract the module block (source and version)
            grep -Pzo '(?s)module\s+"[^"]+"\s*{[^}]*}' "$file" | while read -r module_block; do
              MODULE_SOURCE=$(echo "$module_block" | grep -oP 'source\s*=\s*"\K[^"]+')
              
              # Filter modules where source starts with "terraform-aws-modules"
              if [[ ! "$MODULE_SOURCE" =~ ^terraform-aws-modules ]]; then
                continue
              fi
      
              MODULE_VERSION=$(echo "$module_block" | grep -oP 'version\s*=\s*"\K[^"]+')
      
              if [[ -z "$MODULE_SOURCE" || -z "$MODULE_VERSION" ]]; then
                continue
              fi
      
              # Get the module registry URL
              MODULE_REGISTRY_URL="https://registry.terraform.io/modules/${MODULE_SOURCE}"
      
              # Build the status
              STATUS="ðŸ”´ âŒ Not Supported"
              REGISTRY_URL="https://registry.terraform.io/v1/modules/$MODULE_SOURCE/versions"
              MODULE_VERSIONS=$(curl -s "$REGISTRY_URL" | jq -r '.modules[0].versions[].version' | sort -V)
              LATEST_VERSION=$(echo "$MODULE_VERSIONS" | tail -n 1)
      
              CONSTRAINT_SYMBOL=$(echo "$MODULE_VERSION" | grep -o '^[~>=<]*')
              VERSION_NUMBER=$(echo "$MODULE_VERSION" | sed 's/^[~>=<]*//')
      
              if [[ -z "$CONSTRAINT_SYMBOL" ]]; then
                STATUS=$([[ "$VERSION_NUMBER" == "$LATEST_VERSION" ]] && echo "ðŸŸ¢ âœ… Up-to-date" || echo "ðŸ”´ âŒ Outdated")
              elif [[ "$CONSTRAINT_SYMBOL" == "=" ]]; then
                STATUS=$([[ "$VERSION_NUMBER" == "$LATEST_VERSION" ]] && echo "ðŸŸ¢ âœ… Up-to-date" || echo "ðŸ”´ âŒ Not Supported")
              elif [[ "$CONSTRAINT_SYMBOL" == ">" || "$CONSTRAINT_SYMBOL" == ">=" ]]; then
                STATUS="ðŸŸ¡ âœ… Supported"
              elif [[ "$CONSTRAINT_SYMBOL" == "<" || "$CONSTRAINT_SYMBOL" == "<=" ]]; then
                STATUS=$([[ $(echo -e "$VERSION_NUMBER\n$LATEST_VERSION" | sort -V | tail -n1) == "$VERSION_NUMBER" ]] && echo "ðŸ”´ âŒ Not Supported" || echo "ðŸŸ¡ âœ… Supported")
              elif [[ "$CONSTRAINT_SYMBOL" == "~>" ]]; then
                MAJOR_MINOR=$(echo "$VERSION_NUMBER" | cut -d'.' -f1,2)
                LATEST_MAJOR_MINOR=$(echo "$LATEST_VERSION" | cut -d'.' -f1,2)
                STATUS=$([[ "$MAJOR_MINOR" == "$LATEST_MAJOR_MINOR" ]] && echo "ðŸŸ¡ âœ… Supported" || echo "ðŸ”´ âŒ Not Supported")
              fi
      
              # Add the result to the output file
              echo "{\"file\": \"$file\", \"module\": \"$MODULE_SOURCE\", \"module_registry\": \"$MODULE_REGISTRY_URL\", \"current_version\": \"$MODULE_VERSION\", \"latest_version\": \"$LATEST_VERSION\", \"status\": \"$STATUS\"}" >> results/result.json
            done
          done
        - name: Format JSON Output
          run: |
            echo "[" > results/final.json
            cat results/result.json | sed '$!s/$/,/' >> results/final.json
            echo "]" >> results/final.json
        - name: Upload JSON to S3
          run: |
            aws s3 cp results/final.json s3://$S3_BUCKET_NAME/final.json --acl public-read --region $AWS_REGION      
